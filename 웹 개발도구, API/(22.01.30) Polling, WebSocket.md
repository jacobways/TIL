# Polling, WebSocket

***

## Polling

### 1. HTTP의 비연결성
- HTTP는 클라이언트가 보낸 요청에 대해 서버가 응답을 마치면 맺었던 연결을 끊어 버리는 비연결성의 성질을 가짐

- 서버가 연결을 유지하기 위한 리소스를 줄이면 더 많은 연결을 할 수 있기 때문

- HTTP가 양방향 통신(full-duplex)이 아닌 request, response 형태의 단방향 통신(half-duplex) 모델임을 의미

### 2. Polling
- polling : 프로그램이나 장치에서 다른 프로그램이나 장치들이 어떤 상태에 있는지를 지속적으로 체크하는 전송제어 방식 (버스 카드 단말기, OS 시스템 등)

- HTTP에서 polling : 클라이언트와 서버가 실시간 통신을 하는 것처럼 느끼기 위해 클라이언트가 일정 간격 동안 계속해서 요청을 보내는 방식

- HTTP 통신에서는 서버는 클라이언트에게 요청을 받기 전까지 절대 원하는 타이밍에 먼저 응답(push)을 줄 수 없기에, 웹소켓 프로토콜 등장 전에 사용됨

***

## Long Polling
- polling 방식을 보완하기 위해 등장한 long polling 방식 등장

- long polling, polling 모두 무한히 서버에게 요청을 보내는 것은 동일

### 1. 방식
- long polling은 일정 간격마다 요청을 보내지 않고 처음 요청을 보낸 뒤 서버에서 time-out 될 때까지 일정 시간을 기다림

- time-out 시간이 초과되기 전에 서버에서 데이터를 전송하게 되면 클라이언트는 응답을 받고 다시 요청을 보냄

- 만약 보낼 데이터가 없어 time-out이 되면 클라이언트는 다시 요청을 보냄

### 2. 장단점
- 변경된 데이터가 있을 시에만 응답이 이루어지기 때문에 polling 방식보다 서버의 부하도 적으며 실시간성도 높음

- http의 단방향 메시지 교환 규칙을 변경하지 않고 구현했기에 http 프로토콜의 한계를 보임

- 즉 데이터가 자주 바뀔 시(e.g. 여러 명의 유저가 많은 양의 채팅 전송) 여전히 헤더가 포함된 많은 양의 요청을 보내야 함

***

## WebSocket
- 웹소켓 : http의 단방향 연결 방식이 아닌 양방향 연결을 위한 프로토콜을 HTTP 내에서 별도로 정의한 연결부

### 1. 특징
- TCP 기반에서 작동하는 프로토콜로 http와 같이 OSI 7 계층에서 7번째 애플리케이션 레이어에 속함

- 클라이언트에 의해 먼저 요청을 받는 방식이 아닌, 서버가 내용을 클라이언트에 보내는 방식을 표준화하여 제공

- 연결이 유지된 상태에서 메시지들을 오갈 수 있게 허용함으로써 실시간 소통을 가능

- HTTP 포트 80(ws)과 443(wws) 위에 동작하도록 설계

### 2. 웹소켓 프로토콜

- 웹소켓 프로토콜(ws, wss)은 대부분의 브라우저(2020년 기준 90%의 브라우저)에서 지원

- 웹소켓 프로토콜(ws, wss)은 온라인 게임이나 주식 트레이딩 시스템같이 데이터 교환이 지속적으로 이뤄져야 하는 실시간 서비스에서 많이 사용

- 웹소켓의 두 프로토콜(ws, wss)의 관계는 HTTP와 HTTPS의 관계와 유사하며, 보안 측면에서 wss 프로토콜을 사용하는 것을 권장

***

## WebSocket Handshake
- 웹소켓은 HTTP 프로토콜과 호환되기에 웹 소켓 핸드쉐이크 과정에서 HTTP upgrade 헤더를 사용하여 HTTP 내의 웹 소켓 프로토콜로 변경

- 핸드쉐이크: 정상적인 통신이 시작되기 전에 양측 간에 조건에 합의해가는 정보 교환 과정

- MDN : https://developer.mozilla.org/ko/docs/Web/API/WebSockets_API/Writing_WebSocket_client_applications

### 1. 핸드쉐이크 요청
- 브라우저가 "Upgrade: WebSocket" 헤더 등과 함께 랜덤하게 생성한 키를 서버에 보냄

- HTTP 1.1로 요청을 하고, 웹 소켓 프로토콜로 Upgrade : websocket 해줄 것을 요청

- 요청 헤더에는 소켓 버전과 소켓 비밀키 정보 등을 포함

### 2. 핸드쉐이크 응답
- 웹 서버는 이 키를 바탕으로 토큰을 생성한 후 브라우저에 돌려주는 방식으로 작동

- http 1.1에서 WebSocket으로 프로토콜 업그레이드가 성공되면 HTTP status 101 응답을 전송

- 만약 연결이 정상적으로 이루어진다면 서버와 클라이언트 간에 WebSocket 연결이 이루어지고 일정 시간이 지나면 HTTP 연결은 자동으로 끊어짐
