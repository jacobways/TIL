# Promise, async-await ë³´ì¶©

- ë“œë¦¼ì½”ë”© ì—˜ë¦¬ ì˜ìƒ ìš”ì•½

---

## ì½œë°±í•¨ìˆ˜ì™€ ë¹„ë™ê¸°

- ë™ê¸°ì  ì½œë°± í•¨ìˆ˜

```js
function printImmediately(print) {
  print();
}
printImmediately(() => console.log('hello'));
```

- ë¹„ë™ê¸°ì  ì½œë°± í•¨ìˆ˜

```js
// setTimeoutìœ¼ë¡œ ì‹œê°„ ì„¤ì •

function printWithDelay(print, timeout) {
  setTimeout(print, timeout);
}
printWithDelay(() => console.log('async callback'), 2000);
```

- ì½œë°± ì§€ì˜¥ ì˜ˆì‹œ

```js
class UserStorage {
  loginUser(id, password, onSuccess, onError) {
    setTimeout(() => {
      if (
        (id === 'jacob' && password === '1234') ||
        (id === 'jiyun' && password === '12345')
      ) {
        onSuccess(id);
      } else {
        onError(new Error('not found'));
      }
    }, 2000);
  }

  getRoles(user, onSuccess, onError) {
    setTimeout(() => {
      if (user === 'jacob') {
        onSuccess({ name: 'jacob', role: 'leader' });
      } else {
        onError(new Error('not found'));
      }
    }, 1000);
  }
}

// Promiseë¡œ í•´ê²°í•˜ê¸°
class UserStorage {
  loginUser(id, password) {
    return new Promise((resolve, reject) => {
      setTimeout(() => {
        if (
          (id === 'jacob' && password === '1234') ||
          (id === 'jiyun' && password === '12345')
        ) {
          resolve(id);
        } else {
          reject(new Error('not found'));
        }
      }, 2000);
    });
  }

  getRoles(user) {
    return new Promise((resolve, reject) => {
      setTimeout(() => {
        if (user === 'jacob') {
          resolve({ name: 'jacob', role: 'leader' });
        } else {
          reject(new Error('not found'));
        }
      }, 1000);
    });
  }
}

const UserStorages = new UserStorage();
const id = prompt('enter your id');
const password = prompt('enter your password');
UserStorages.loginUser(id, password)
  .then(UserStorages.getRoles)
  .then((user) => alert(`Hello ${user.name}, you have a ${user.role} role`))
  .catch(console.log);
```

---

## Promise

### 1. Promiseë€?

- Promise : ìë°”ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì œê³µí•˜ëŠ” ë¹„ë™ê¸° ê°„í¸í•˜ê²Œ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” object

- ìš©ë„ : ì½œë°±í•¨ìˆ˜ ëŒ€ì‹  ìœ ìš©í•˜ê²Œ ì‚¬ìš©

### 2. Promiseì˜ ìƒíƒœì™€ ê²°ê³¼

- ìƒíƒœ(State) : í”„ë¡œì„¸ìŠ¤ê°€ ìˆ˜í–‰ì¤‘ì¸ì§€ ì™„ë£Œë˜ì—ˆëŠ”ì§€ ë³´ì—¬ì¤Œ

  - Pending : í”„ë¡œì„¸ìŠ¤ê°€ ìˆ˜í–‰ì¤‘ì¸ ìƒíƒœ

- ê²°ê³¼ : í”„ë¡œì„¸ìŠ¤ê°€ ì™„ë£Œëœ ìƒíƒœ

  - fulfilled : í”„ë¡œì„¸ìŠ¤ê°€ ì™„ë£Œë˜ì–´ ì„±ê³µí•œ ìƒíƒœ

  - rejected : í”„ë¡œì„¸ìŠ¤ê°€ ì™„ë£Œë˜ì—ˆì§€ë§Œ ì‹¤íŒ¨í•œ ìƒíƒœ

### 3. Promiseì˜ íŠ¹ì§•

- Promise ì•ˆì—ëŠ” heavyí•œ ì‘ì—…ì´ ë“¤ì–´ê°€ëŠ”ë°, ì‹œê°„ì´ ê±¸ë¦¬ëŠ” ì´ ì‘ì—…ì„ ë¹„ë™ê¸°ì ìœ¼ë¡œ ì‹¤í–‰í•˜ì—¬ ê·¸ ë™ì•ˆ ë‹¤ë¥¸ ì‘ì—…ë„ ê°€ëŠ¥í•˜ê²Œ í•˜ê¸° ìœ„í•¨

- Promise ê°ì²´ë¥¼ ë§Œë“¤ìë§ˆì ì½œë°±í•¨ìˆ˜ê°€ ë°”ë¡œ ì‹¤í–‰ë˜ê¸° ë•Œë¬¸ì— í´ë¼ì´ì–¸íŠ¸ê°€ ìš”ì²­í–ˆì„ ë•Œë§Œ ì‹¤í–‰ë  ìˆ˜ ìˆë„ë¡ í†µì œê°€ í•„ìš”í•œ ê²½ìš°ê°€ ìˆìŒ

- Promiseì˜ ìƒì„±ìë¥¼ ë³´ë©´ Promise ì•ˆì— 2ê°œì˜ ì½œë°±í•¨ìˆ˜ë¥¼ ë°›ê²Œ ë˜ì–´ ìˆìŒ (ì„±ê³µì‹œ ì „ë‹¬í•  resolve, ì‹¤íŒ¨ì‹œ ì „ë‹¬í•  reject)

### 3. Promise ì‚¬ìš©ë²•

- Producerë¥¼ í†µí•œ Promise ìƒì„± : new í‚¤ì›Œë“œì™€ Promise ìƒì„±ì ì‚¬ìš©

  - ì½œë°±í•¨ìˆ˜ resolve() : ì„±ê³µ ì‹œ ì „ë‹¬í•  ê°’ì„ ê´„í˜¸ ì•ˆì— ì…ë ¥

  - ì½œë°±í•¨ìˆ˜ reject() : ì‹¤íŒ¨ ì‹œ ì „ë‹¬í•  ê°’ì„ ê´„í˜¸ ì•ˆì— ì…ë ¥

```js
const promise = new Promise((resolve, reject) => {
  // promise ëŠ” í´ë˜ìŠ¤ì´ê¸° ë•Œë¬¸ì— new í‚¤ì›Œë“œë¡œ ê°ì²´ ìƒì„± ê°€ëŠ¥
  console.log('doing something...');
  setTimeout(() => {
    resolve('jacob'); // resolve ê´„í˜¸ ì•ˆì—ìˆëŠ” ê°’ì´ ì „ë‹¬ë¨
    /* reject(new Error('no network')); */ // Error í´ë˜ìŠ¤ëŠ” ìë°”ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì œê³µí•˜ëŠ” í´ë˜ìŠ¤ì´ë©° ì—ëŸ¬ê°€ ë°œìƒí•˜ëŠ” ê±¸ ë‚˜íƒ€ë‚´ëŠ” ê°ì²´
  }, 2000);
});
```

- Consumerë¥¼ í†µí•œ Promise ì‚¬ìš© : Consumerë¬¸ ì•ˆì— ì½œë°±í•¨ìˆ˜ë¥¼ ë„£ì–´ì„œ ê°’ì„ ë°›ì•„ì˜¤ê¸°

  - then : Promiseê°€ ì •ìƒì ìœ¼ë¡œ ìˆ˜í–‰ë  ë•Œ, resolve() ê´„í˜¸ ì•ˆì˜ ê°’ì„ ë°›ì„ ë•Œ ì‚¬ìš©

  - catch : promise ìˆ˜í–‰ì´ ì‹¤íŒ¨í•  ê²½ìš°, reject() ê´„í˜¸ ì•ˆì˜ ê°’ì„ ë°›ì„ ë•Œ ì‚¬ìš©

  - finally : ì„±ê³µ/ì‹¤íŒ¨ì™€ ìƒê´€ì—†ì´ ë§ˆì§€ë§‰ì— ê¸°ëŠ¥ì„ ìˆ˜í–‰

  - Consumerë¬¸ì—ì„œ returnì„ í•˜ë©´ ë‹¤ìŒ consumer ë¬¸ì€ ì´ return ê°’ì„ ë°›ìŒ

```js
promise
  .then((value) => {
    // valueëŠ” resolve ì½œë°± í•¨ìˆ˜ ì•ˆì— ë“¤ì–´ìˆëŠ” 'jacob' ì´ ë¨
    console.log(value);
  }) // ìœ„ì˜ thenì€ ê²°êµ­ ë˜‘ê°™ì€ promiseë¥¼ ë¦¬í„´í•˜ê¸° ë•Œë¬¸ì— ë°”ë¡œ catch ì‚¬ìš© ê°€ëŠ¥ - ì´ê²ƒì´ promise chaining
  .catch((error) => {
    // catchë¬¸ì€ promise ìˆ˜í–‰ì´ ì‹¤íŒ¨í•  ê²½ìš° rejectê°’ì„ ë°›ì„ ë•Œ ì‚¬ìš©
    console.log(error);
  })
  .finally(() => {
    // finallyëŠ” ìµœê·¼ë° ë“±ì¥í•œ ê²ƒìœ¼ë¡œ ì„±ê³µ/ì‹¤íŒ¨ì™€ ìƒê´€ì—†ì´ ê¸°ëŠ¥ì„ ë§ˆì§€ë§‰ì— ìˆ˜í–‰
    console.log('finally');
  });
```

- Promise Chaining

```js
const fetchNumber = new Promise((resolve, reject) => {
  setTimeout(() => resolve(1), 1000);
});

fetchNumber
  .then((num) => num * 2) // numì€ 2ê°€ ë¨  // returnì„ í•´ì£¼ë©´ ê·¸ ê°’(2)ì„ ë‹¤ìŒ .thenì—ì„œ ë°›ìŒ
  .then((num) => num * 3) // numì€ 6ì´ ë¨
  .then((num) => {
    // thenì€ ë˜ ë‹¤ë¥¸ promiseë¥¼ ë¦¬í„´í•  ìˆ˜ ìˆìŒ
    return new Promise((resolve, reject) => {
      setTimeout(() => resolve(num - 1), 1000); // numì€ 5ê°€ ë¨
    });
  })
  .then((num) => console.log(num));
```

- Error Handling

```js
const getHen = () =>
  new Promise((resolve, reject) => {
    setTimeout(() => resolve('ğŸ”'), 1000);
  });
const getEgg = (hen) =>
  new Promise((resolve, reject) => {
    setTimeout(() => resolve(`${hen} => ğŸ¥š`), 1000);
  });
const cook = (egg) =>
  new Promise((resolve, reject) => {
    setTimeout(() => resolve(`${egg} => ğŸ³`), 1000);
  });

getHen()
  .then((hen) => getEgg(hen)) // .then(getEgg)ë¡œ í‘œê¸° ê°€ëŠ¥ : ë°›ì•„ì˜¤ëŠ” ê°’ì„ ì½œë°±í•¨ìˆ˜ì—ì„œ ë°”ë¡œ í˜¸ì¶œí•˜ëŠ” ê²½ìš°
  .catch((error) => {
    // ì—ëŸ¬í•¸ë“¤ë§ : ì¤‘ë‹¨ì— ë‹¬ê±€ì„ ë°›ì„ ìˆ˜ ì—†ìœ¼ë©´ ë¹µìœ¼ë¡œ ëŒ€ì²´
    return 'ğŸ¥–';
  })
  .then((egg) => cook(egg)) // .then(cook)
  .then((meal) => console.log(meal)) // .then(console.log)
  .catch(console.log);
```

---

## async & await

- ìƒˆë¡œìš´ ê²ƒì´ ì•„ë‹Œ ê¸°ì¡´ ê²ƒì„ ê°„í¸í•˜ê²Œ í•´ì£¼ëŠ” syntactic sugar (ex. í´ë˜ìŠ¤)

- async & awaitì™€ Promises ëª¨ë‘ í•„ìš”í•  ë•Œê°€ ê°ê° ìˆê¸° ë•Œë¬¸ì— ë¬´ì¡°ê±´ async & awaitë¥¼ ì“°ì§€ ì•Šì•„ë„ ë¨

### 1. async

- í•¨ìˆ˜ ì•ì— async í‚¤ì›Œë“œë¥¼ ë¶™ì´ë©´ í•¨ìˆ˜ ì•ˆì— ì½”ë“œë¸”ëŸ­ì´ Promiseë¡œ ë°”ë€œ

```js
// Producerë¥¼ Promiseë¡œ í‘œí˜„

function fetchUser() {
  return new Promise((resolve, reject) => {
    resolve('jacob'); // resolve í˜¸ì¶œ ì—†ì´ ê·¸ëƒ¥ return 'jacob'ì„ í•´ì£¼ë©´ promise stateê°€ pending ìƒíƒœê°€ ë¨
  });
}

// Producerë¥¼ asyncë¡œ í‘œí˜„

async function fetchUser() {
  // í•¨ìˆ˜ ì•ì— asyncë¥¼ ì“°ë©´ promiseë¥¼ ì“°ì§€ ì•Šì•„ë„ í•¨ìˆ˜ ì•ˆì˜ ì½”ë“œ ë¸”ëŸ­ì´ promiseê°€ ë¨
  return 'jacob';
}

// Consumer ì‚¬ìš©

const user = fetchUser();
user.then(console.log);
console.log(user);
```

### 2. await

- awaitì€ asyncê°€ ìˆëŠ” í•¨ìˆ˜ ì•ˆì—ì„œë§Œ ì“¸ ìˆ˜ ìˆìŒ

```js
// ì •í•´ì§„ msê°€ ì§€ë‚˜ë©´ Promise ë¦¬í„´í•˜ëŠ” í•¨ìˆ˜
function delay(ms) {
  return new Promise((resolve) => setTimeout(resolve, ms));
}

// Promiseì˜ consumerë¥¼ ì´ìš©í•˜ì—¬ í•¨ìˆ˜ë¥¼ ë§Œë“¤ ë•Œ async & await ì‚¬ìš©
async function getApple() {
  await delay(2000); // awaitì„ í†µí•´ 2ì´ˆ ê¸°ë‹¤ë ¤ ì¤Œ
  /* throw 'error'; */ //ì—ëŸ¬ì²˜ë¦¬
  return 'ğŸ';
}

// Promiseì˜ consumerë¥¼ ì´ìš©í•˜ì—¬ í•¨ìˆ˜ë¥¼ ë§Œë“¤ ë•Œ Promise ì‚¬ìš©
function getBanana() {
  return delay(1000).then(() => 'ğŸŒ');
}

// async & await ì‚¬ìš©í•˜ì—¬ ë³€ê²½
async function getBanana() {
  await delay(1000);
  return 'ğŸŒ';
}

// í•¨ìˆ˜ë¥¼ Promiseì˜ consumerë¥¼ ì‚¬ìš©í•˜ì—¬ í‘œí˜„í–ˆëŠ”ë° ì½œë°± ì§€ì˜¥ê³¼ ë¹„ìŠ·í•œ ìƒí™© ë°œìƒ
function pickFruits() {
  return getApple().then((apple) => {
    return getBanana().then((banana) => `${apple} + ${banana}`);
  });
}

// async & awaitë¥¼ ì‚¬ìš©í•˜ì—¬ ê°„ë‹¨í•˜ê²Œ ë³€ê²½
async function pickFruits() {
  const apple = await getApple();
  const banana = await getBanana();
  return `${apple} + ${banana}`;
  // 2ì´ˆì— appleì´ ë¨¼ì € ì‹¤í–‰ë˜ê³  1ì´ˆ í›„ bananaê°€ ì‹¤í–‰ë¨ : 3ì´ˆ ë’¤ì— ì‚¬ê³¼ì™€ ë°”ë‚˜ë‚˜ê°€ ëª¨ë‘ ë™ì‹œì— í‘œì‹œë¨
}

pickFruits().then(console.log);
```

## Promose.all ê³¼ Promise.race

### 1. Promise.all

- Promiseê°€ ìˆœì°¨ì ì´ ì•„ë‹Œ ë³‘ë ¬ì ìœ¼ë¡œ ì‹¤í–‰ë˜ê²Œ ë§Œë“¬

- ì´ë¯¸ ì‹¤í–‰ëœ Promiseê°€ ìˆì–´ë„, ëª¨ë“  Promiseê°€ ì‹¤í–‰ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼

- í•˜ë‚˜ë¼ë„ errorê°€ ë°œìƒí•˜ë©´ ì „ì²´ë¥¼ ì‹¤íŒ¨ë¡œ ì²˜ë¦¬

```js
// async & awaitë¥¼ í†µí•´ ì‚¬ê³¼(2ì´ˆ)ì™€ ë°”ë‚˜ë‚˜(1ì´ˆ)ë¥¼ ë³‘ë ¬ì ìœ¼ë¡œ ì‹¤í–‰í•˜ê²Œ ë§Œë“¤ì–´ 2ì´ˆ ë’¤ ì‚¬ê³¼ì™€ ë°”ë‚˜ë‚˜ ë™ì‹œì— ë¦¬í„´
async function pickFruits() {
  const applePromise = getApple();
  const bananaPromise = getBanana();
  const apple = await applePromise;
  const banana = await bananaPromise;
  return `${apple} + ${banana}`;
}

// Promise.allì„ ì‚¬ìš©í•˜ì—¬ ë³´ë‹¤ ê°„í¸í•˜ê²Œ í‘œí˜„
function pickAllFruits() {
  return Promise.all([getApple(), getBanana()]).then((fruits) =>
    fruits.join(' + ')
  );
}
pickAllFruits().then(console.log);
```

### 2. Promise.race

- ì—¬ëŸ¬ ê°œì˜ Promiseì¤‘ ê°€ì¥ ë¨¼ì € ì™„ë£Œë˜ëŠ” Promiseë§Œ ì‹¤í–‰

```js
function pickOnlyOne() {
  return Promise.race([getApple(), getBanana()]);
}

pickOnlyOne().then(console.log); // ë¨¼ì € ì™„ë£Œë˜ëŠ” ë°”ë‚˜ë‚˜ ì¶œë ¥
```
