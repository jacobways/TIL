# 웹 캐시, CDN

***

## 웹 캐시
- 캐시 : 데이터나 값을 미리 복사해 놓는 임시 장소

### 
- 캐시 없을 경우 네트워크를 통해 같은 데이터를 또 다운받아야 함
- 용량이 클 수록 비용이 커지고 브라우저의 로딩속도가 느려짐

- 캐시에 데이터를 미리 복사해 놓으면 계산이나 접근 시간 없이 더 빠른 속도로 데이터에 접근
- 브라우저에 캐시를 저장할 땐 헤더에 cache-control 속성을 통해 캐시가 유효한 시간을 지정할 수 있음

### 캐시의 유효기간
- 클라이언트의 첫 번째 요청에 대한 응답으로 캐시를 보내면 두 번째 요청에서는 캐시를 우선 조회
- 유효한 캐시라면 캐시에서 데이터 가져옴
- 유효기간이 지난 캐시를 재사용하려면 조건부 요청 필요

### 캐시 검증 헤더와 조건부 요청 과정

- Last Modified와 If-Modified-Since
  - 검증 헤더의 Last Modified : 데이터가 마지막으로 수정된 시간정보를 헤더에 포함
  - 두 번째 요청의 If-Modified-Since : 캐시 유효기간이 초과되더라도 클라이언트에서 헤더를 통해 조건부 요청 가능
  - 서버의 해당 자료 최종 수정일과 비교해서 수정이 안되었다면 응답 메세지 담아서 알려줌 (304 Not Modified)
  - 서버는 body를 제외한 헤더만 전달해주고, 클라이언트는 이 헤더 정보로 캐시의 메타데이터를 갱신하며 캐시 재사용

- ETag와 If-None-Match
  - ETag : 캐시용 데이터에 임의의 고유한 버전 이름을 달아둠
  - 서버에서 헤더에 ETag를 작성에 응답하고 클라이언트는 캐시에서 이 ETag를 저장
  - If-None-Match : 캐시시간이 초과되었다면 클라이언트는 ETag값을 검증하는 If-None-Match를 요청 헤더에 작성
  - 서버는 데이터가 수정되었는지 ETag를 통해 검증하고 수정되지 않았다면 헤더만 전송 (304 Not Modified)
  - 서버는 body를 제외한 헤더만 전달해주고, 클라이언트는 이 헤더 정보로 캐시의 메타데이터를 갱신하며 캐시 재사용

### 캐시 관련 헤더와 조건부 요청 헤더

- 캐시 지시어(directives)
  - Cache-Control : max-age (캐시 유효 기간으로 초 단위)
  - Cache-Control : no-cache (캐시 가능하지만 Origin 서버에 검증하고 사용)
  - Cache-Control : no-store (캐시를 저장하지 않기 - 메모리에서 사용하고 최대한 빨리 삭제)
  - Expires : 캐시 만료일을 날짜로 지정 (max-age를 권장하며 같이 사용시 Expires 무시)

## 프록시 캐시(Proxy Cache)
- 프록시(Proxy) : 클라이언트와 서버 사이에 대리로 통신을 수행하는 것
- 프록시 서버 : 그 중계 기능을 하는 서버로 클라이언트가 다른 네트워크와 서버 사이에 대리로 통신을 수행하는 것
- 클라이언트와 원 서버 사이 프록시 캐시 서버를 위치시켜 빠른 속도로 자료 제공
- Private 캐시 : 클라이언트의 캐시 / Public 캐시 : 프록시 서버의 캐시

### 캐시 지시어
- 설정
  - Cache-Control : public - 응답이 public 캐시에 저장되어도 됨
  - Cache-Control : private - 응답이 해당 사용자만을 위한 것이므로 private 캐시에 저장 (기본값)
  - Cache-Control : s-maxage - 프록시 캐시에만 적용되는 max-age
  - Age: 60 (HTTP 헤더) - 오리진 서버에서 응답 후 프록시 캐시 내 머문 시간 (초)

- 캐시 무효화
  - Cache-Control : no-cache
    - 데이터 캐시는 가능하지만 원 서버에 검증하기
    - max-age=0과 같은 효과
    - 원 서버와 연결 실패시 응답으로 오류가 아닌 오래된 데이터 전송 (200 OK)
  - Cache-Control : no-store
    - 데이터에 민감한 정보가 있으므로 저장하지 않고 사용 후 바로 삭제
  - Cache-Control : must-revalidate
    - 캐시 만료 후 원 서버에 검증해야 함
    - 원 서버 접근 실패시 반드시 오류 발생 (504:Gateway Timeout)
  - Pragma: no-cache (HTTP 1.0 하위 호환)

- 확실히 캐시 무효화하기 (아래 지시어 모두 넣어야 함)
  - Cache-Control : no-cache, no-store, must-revalidate
  - Pragma: no-cache

***

## CDN (Content Delivery Network)
- 콘텐츠를 빠르고 효율적으로 전달하기 위해 등장한 서비스
- 세계 곳곳의 데이터 센터에 콘텐츠를 저장해두고, 요청을 받으면 지리적으로 가까운 센터에서 콘텐츠 제공

### 1. CDN 특징
- 원본을 복사하여 저장할 여러 개의 캐시 서버로 구성
- 콘텐츠를 요청받은 경우 데이터 전달에 가장 유리한 캐시 서버에서 콘텐츠 제공
- 제공할 콘텐츠를 가지고 있는 서버 중 지리적으로 가장 가까운 곳이 우선순위 가짐

### 2. 정적 콘텐츠와 동적 콘텐츠
- 정적 콘텐츠 : 내용이 거의 변하지 않는 콘텐츠
  - HTML 파일, 동영상, 개인화되지 않은 대중적 콘텐츠 등
  - 변화가 없기 때문에 CDN 캐시 센터 저장에 적합

- 동적 콘텐츠 : 접속할 때마다 내용이 바뀌거나 사용자마자 다른 내용을 보여주는 콘텐츠
  - 위치, IP 주소, 사용시간 등 개인화된 정보
  - 공통적인 HTML 파일부분만 캐시 서버에 저장

### 3. CDN 의 이점
- DDos 공격에 대해 어느정도 대응이 가능 (한 서버가 공격 받으면 다른 서버 사용 가능)
- 로딩속도 감소로 인한 사용자 경험 향상
- 트래픽 분산으로 인해 관련 비용 절감

### 4. 네트워크 구성 방식
- Scattered 방식
  - 최대한 빠른 응답속도를 목표
  - 세계 곳곳에 비교적 낮은 성능의 데이터 센터를 구성하고 연결해 두기
  - 데이터센터의 수가 많기 때문에 데이터 센터 유지 비용 또한 높음
  - 수요가 적은 지역에 데이터 센터를 세워야 할때는 해당 방식이 유리

- Consolidated 방식
  - 데이터 센터들을 통합하여 운용하는 방식
  - 고성능의 데이터 센터들을 운용
  - 응답시간이 증가 하지만 데이터 센터의 수가 줄어듦으로 데이터 센터의 관리 및 유지 비용을 절감
  - 연결 수요가 많은 지역에 데이터 센터를 설립해야 한다면 적절한 방식
