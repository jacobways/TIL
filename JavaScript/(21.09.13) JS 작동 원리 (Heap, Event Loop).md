# JS 작동 원리 (Heap, Event Loop)

***

## 메모리 힙(Heap)과 콜 스택(Call Stack)
- 콜 스택 : 원사타입 데이터 저장 & 실행 컨텍스트를 통한 관리 (변수명 저장, 스코프와 this, 코드 실행 순서)

- 메모리 힙 : 참조타입 데이터 저장

- 참고링크 : https://curryyou.tistory.com/276

<img width="600" alt="스크린샷 2021-09-13 오후 2 07 44" src="https://user-images.githubusercontent.com/80403988/133027278-4950dd32-9a0b-411c-bb3a-0e5e268786a6.png">

***

## 원시타입 데이터 : 콜 스택에 저장

### 1. 원시타입 데이터의 변수 생성과 데이터 저장
- 콜 스택에 저장하는 내용

  - 선언된 변수를 저장하고, 할당된 데이터 값이 저장된 콜 스택의 주소값을 이 변수에 저장

  - 변수에 할당된 원시타입 데이터 (변수에 저장된 주소값에 따라 해당 데이터 조회 가능)

<img width="350" alt="스크린샷 2021-09-13 오후 2 08 37" src="https://user-images.githubusercontent.com/80403988/133027297-3a38f919-ecc7-44cc-b70d-9b8fb6f87d58.png">

### 2. 원시타입 데이터 재할당 : 메모리에 저장된 값은 변경하지 않음
- 기존에 존재하는 데이터를 재할당 할 경우 : 메모리의 값은 변경하지 않고, 변수에 저장된 메모리의 주소만 변경
```js
let a = 10
let b = 20
a = 20
// a와 연결된 메모리의 값을 10에서 20으로 변경하지 않고, 기존 20을 저장중인 메모리의 주소값으로 교체
// a와 b의 주소값이 동일해짐
```

<img width="350" alt="스크린샷 2021-09-13 오후 2 08 50" src="https://user-images.githubusercontent.com/80403988/133027307-3dbe5e6c-ada7-448e-b469-29c3bf6dd88a.png">

- 새로운 데이터를 재할당 할 경우 : 새로운 메모리를 확보하고, 그에 해당하는 새 주소를 변수에 저장
```js
let a = 10
let b = 20
a = 20
b = 30
// b와 연결된 메모리의 값을 20에서 30으로 변경하지 않고, 새로운 값인 30을 저장할 새로운 메모리를 확보
// 변수 b의 주소에 30이 저장된 메모리 주소를 연결
```

<img width="350" alt="스크린샷 2021-09-13 오후 2 08 58" src="https://user-images.githubusercontent.com/80403988/133027312-3919b2b7-e06b-4740-b422-f86a877742fa.png">

- let으로 선언된 변수는 재할당이 가능하지만, const으로 선언된 변수는 재할당 불가능

### 3. 가비지 컬렉터
- 메모리에서 더 이상 참조되지 않은 데이터는 가비지 컬렉터에 의해 삭제됨
```js
let a = 10
let b = 20
a = 20
b = 30
// 10이라는 데이터는 더 이상 참조되지 않음
```

<img width="450" alt="스크린샷 2021-09-13 오후 2 09 09" src="https://user-images.githubusercontent.com/80403988/133027344-34af192b-4bd9-48d9-b6ad-3c0e146027f3.png">

## 참조타입 데이터

### 1. 참조타입 데이터의 변수 생성과 데이터 저장
- 콜 스택에 저장하는 내용

  - 선언된 변수를 저장하고, 할당된 데이터 값이 저장된 콜 스택의 주소값을 이 변수에 저장

  - 변수에 할당된 데이터를 콜 스택에 저장하는 대신 해당 데이터를 보관하는 메모리 힙의 주소를 저장

- 메모리 힙에 저장하는 내용

  - 변수에 할당 된 참조타입 데이터 (콜 스택에 해당 데이터의 메모리 힙 주소가 저장되어 있음)

<img width="500" alt="스크린샷 2021-09-13 오후 2 09 22" src="https://user-images.githubusercontent.com/80403988/133027354-e9ad1152-c6b2-4870-af65-b43a2cd5a59a.png">

### 2. 참조타입 데이터 값 변경 : 메모리에 저장된 값을 변경
- 변수에 데이터를 재할당하지 않고, 메모리 힙에 저장된 데이터를 수정

- 메모리 힙에 저장된 데이터의 내용을 변경해도, 저장되는 메모리 힙의 주소는 동일
```js
const a = [1,2,3]
let b = [4,5,6]
a.push(100)  // a = [1,2,3,100]
b.push(200)  // b = [4,5,6,200]
```

<img width="500" alt="스크린샷 2021-09-13 오후 2 09 33" src="https://user-images.githubusercontent.com/80403988/133027375-e4fd2f37-d3d3-4d42-b3bc-40fab6e634aa.png">

### 3. 참조타입 데이터 재할당
- let 으로 선언된 변수의 재할당 : 새로운 메모리 힙을 확보하여 새로운 값을 저장하고, 변경된 주소를 콜 스택에 저장
```js
const a = [1,2,3]
let b = [4,5,6]
b = [100,200,300]
// 메모리 힙 내 새로운 공간과 주소가 확보되고, 그 주소를 b가 참조하여 콜스택에 저장
```

<img width="500" alt="스크린샷 2021-09-13 오후 2 09 48" src="https://user-images.githubusercontent.com/80403988/133027382-99cf1f54-bac3-4fe9-a975-a08ffc846dfa.png">

- const 으로 선언된 변수의 재할당 : 불가능 (const를 사용하면 콜 스택의 변수에 저장된 주소 값 변경 불가능)
```js
const a = [1,2,3]
let b = [4,5,6]
a = [100,200,300]   // 불가능
```

<img width="500" alt="스크린샷 2021-09-13 오후 2 10 01" src="https://user-images.githubusercontent.com/80403988/133027389-3a74df0f-d4af-4a4e-b467-5c10ea8693ee.png">

***

## Event Loop : 비동기 작동 원리
- 비동기 요청 : AJAX, 타이머(setTimeout), DOM(이벤트 핸들러)

### 1. 관련 용어
- 콜 스택 (Call Stack)

  - JavaScript는 싱글스레드 언어로 한 번에 1개의 코드만 처리 가능

  - 콜 스택은 단 1개이며, JavaScript는 코드를 콜 스택에 넣은 후 순서대로 처리

- 콜백 큐 (Callback Queue)

  - 비동기 코드를 일시적으로 저장하는 장소로 태스크 큐(Task Queue) 라고도 불림

  - 비동기로 처리할 코드는 콜 스택에 바로 넣지 않고, 가상 공간을 거친 후 콜백 큐에 넣음

- 이벤트 루프 (Event Loop)

  - Callback Queue에 있는 코드를 Call Stack으로 이동시킴

  - 콜 스택에 실행중인 작업이 있는지, 콜백 큐에 task가 존재하는지 반복적으로 확인

  - 콜 스택에 처리할 작업이 없을 경우 콜백 큐에서 작업을 꺼내 콜 스택에 넣기

### 2. 비동기 처리 과정
- 태스크들이 콜 스택에 담아짐

- 비동기 태스크들이 백그라운드(ex. Web APIs에게 서비스 요청)에서 처리 (일시적 멀티스레드)

- 백그라운드에서 처리가 완료된 태스크는 콜백 큐로 전달됨

- 콜 스택에 있는 작업들이 순서대로 모두 처리됨

- 콜 스택이 비어있으면, 이벤트 루프는 콜백 큐의 코드를 여기로 하나씩 이동시킴

<img width="550" alt="스크린샷 2021-09-13 오전 11 47 12" src="https://user-images.githubusercontent.com/80403988/133017799-05470210-1667-4d49-adf5-d3f15ebd0800.png">

### 3. 관련 링크
- Event Loop : https://www.youtube.com/watch?v=8aGhZQkoFbQ

- Philip Roberts : Help, I'm stuck in an event-loop https://vimeo.com/96425312
