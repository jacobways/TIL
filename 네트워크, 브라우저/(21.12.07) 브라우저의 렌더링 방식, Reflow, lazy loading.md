# 브라우저의 렌더링 방식, Reflow, lazy loading
- 관련 링크(Naver D2) : https://d2.naver.com/helloworld/59361

***

## 브라우저의 렌더링 방식
- 웹킷 렌더링 과정

![웹킷 렌더링 과정](https://user-images.githubusercontent.com/80403988/145059085-be48edfd-8632-4e9b-8b0b-8122853f1ae2.png)

### 1. Loading
- HTTP 모듈 또는 파일 시스템으로 전달 받은 리소스 스트림을 읽는 과정

- 언어
  - 브라우저가 아는 언어는 HTML, CSS, JS, Web Assembly

  - php, jsp, asp 같은 서버 템플릿 언어도 기본적으로는 HTML으로 내려주게 됨

- HTML 태그

  - Link : 외부 리소스와 연결시켜주는 태그로 연결된 주소를 통해 외부 리소스를 다운 (보통 CSS 파일)

  - Script : JS 파일과 연결시켜주는 태그

  - Img : Link와 마찬가지로 외부 리소스와 연결시켜주어 다운받아오는 태그 (mp4, Video, Audio 동일)

### 2. DOM Tree
- 렌더링 엔진은 전달받은 HTML 문서 파싱하여 DOM 객체 모델을 만듬

- HTML 마크업을 처리하고 DOM 트리를 빌드
  
### 3. CSSSOM Tree
- 다운 받았던 외부 CSS 파일과 함께 포함된 스타일 요소를 파싱해 CSSOM 객체 모델을 만듬

- CSS 마크업을 처리하고 CSSOM 트리를 빌드

### 4. Rendering Tree
- DOM 및 CSSOM 을 결합하여 렌더링 트리를 형성

### 5. Layout (Reflow)
- 렌더 트리의 각 노드에 대해서 화면 상에서 어디에 배치할 지 결정
- 렌더링 트리에서 레이아웃을 실행하여 각 노드의 기하학적 형태를 계산 (Box-Model 생성)
- 컴퓨터의 CPU 사용

### 6. Paint
- UI백엔드에서 렌더 트리를 그림

- 개별 노드를 화면에 페인트함 (래스터화)

- 실질적으로 브라우저 화면 상에 그리는 과정으로 이후 화면이 유저에게 보임

- 컴퓨터의 GPU 사용

***

## 성능개선을 위한 DOM

### 1. DOM/CSSOM 변경에 따른 브라우저 렌더링
- DOM이 변경되면 다시 렌더 트리를 만들고, 레이아웃(조금이라도 배치가 바뀌어도)을 하고, 페인트를 하는 과정이 일어남

- 이 과정에서 Layout은 컴퓨터의 CPU를 많이 먹고, Paint는 GPU를 많이 먹음

### 2. 성능 이슈
- 유저의 눈에 일련의 과정이 부드럽게 처리되기 위해서는 초당 60프레임은 유지 필요 (1프레임 = 0.024초)

- 1 프레임 안에 레이아웃과 페인트 과정을 동시에 해야만하며, 프레임 드랍 현상을 유발함

- 프레임 드랍(Frame Drop)

  - 초당 유지시키던 프레임의 수가 줄어드는 현상을 뜻

  - 줄어들어 드랍이 되어버린 프레임은 렌더링 엔진이 인식할 수 없고 브라우저 화면에 그리지 않음

  - 그래서 유저 입장에서 화면이 버벅이고 멈춤

### 3. 불필요한 Layout 줄이기
- 불필요한 Layout 하나만 줄여도 렌더링 퍼포먼스가 최적화됨

- 레이아웃을 발생시키는 속성들을 파악하기 (주로 CSS)

  - left 속성 : 레아이웃을 발생시키며 left-top, left-bottom 속성을 사용하면 위치가 변경

  - transform 속성 : 레이아웃을 발생시키지 않고 Paint만 다시 발생

  - will-change 속성도 방법

- Layout과 달리 Paint는 필수 과정이므로 최적화시킬 수 있는 방법이 없음

***

## Reflow와 성능

### 1. Reflow란?
- 액션이나 이벤트에 의해 DOM 요소의 크기/위치 등을 변경하면 상하위 노드를 포함하여 Layout 단계를 다시 수행

- 브라우저 렌더링을 위해 DOM 트리를 그리는 과정에서 발생

- 생성된 DOM 노드의 레이아웃 수치 변경 시 영향 받은 모든 노드의(자신, 자식, 부모, 조상, 결국 모든 노드) 수치를 다시 계산하여, 렌더 트리를 재생성하는 과정

### 2. Reflow가 일어나는 상황
- 노드의 추가 또는 제거

- 요소의 위치 변경

- 요소의 크기 변경 (margin, padding, border, width, height 등)

- 폰트, 텍스트 내용 변경

- 이미지 크기 변경

- 페이지 초기 랜더링(최초 Layout 과정)

- 윈도우 리사이징

### 3. Reflow 최적화 방법
- 클래스 변화에 따른 스타일 변경 시, 최대한 DOM 구조 상 끝단에 위치한 노드에 주기
  - 가급적 말단에 위치한 노드의 수치를 변경하면 리플로우 수행 반경을 일부 노드로 제한시킬 수 있음

- 인라인 스타일을 최대한 배제 : 적용 시 코드 가독성과 Reflow 비용을 줄일 수 있음

- 애니메이션이 들어간 노드는 가급적 position:fixed 또는 position:absolute로 지정하여 전체 노드에서 분리 시키기
  - JS + CSS 애니메이션 효과는 해당 프레임에 따라 무수히 많은 Reflow 비용이 발생

  - position 속성을 fixed, absolute로 주면 지정된 노드는 전체 노드에서 분리

  - 즉 전체 노드의 Reflow 비용이 들지 않으며, 해당 노드의 Repaint 비용만 들어가게 됨

***

## 기타 용어

### 1. 파싱
- 문서 파싱 : 브라우저가 코드를 이해하고 사용할 수 있는 구조로 변환하는 것

- 렌더링의 파싱 : 렌더링 과정에서는 전달 받아 읽어들인 HTML 파일을 바탕으로 DOM 트리를 만들게 되는 것

- 파싱 결과 : 보통 문서 구조를 나타내는 노드 트리가 됨 - 파싱 트리(parse tree) 또는 문법 트리(syntax tree)

- 문맥 자유 문법 : 파싱할 수 있는 모든 형식은 정해진 용어와 구문 규칙에 따라야 함

### 2. lazy loading (성능 향상 및 비용 절감 목적)
- 페이지를 읽어들이는 시점에 중요하지 않은 리소스 로딩을 추후에 하는 기술

- 페이지 내에서 바로 필요하지 않은 이미지들의 로딩 시점을 뒤로 미루는 기술

- lazy loading을 사용하면 페이지가 placeholder 콘텐츠로 작성되며, 사용자가 필요할 때만 실제 콘텐츠로 대체 됨

  - 예시 : 브라우저 보여지는 이미지만을 로드하고 나머지 이미지는 스크롤 이벤트가 발생했을 때 다시 로드하는 방식

### 3. CSS Object Model
- CSS 파일을 파싱하고, 파싱 트리를 생성
